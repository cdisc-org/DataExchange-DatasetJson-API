# Dataset-JSON v1.1 REST API User Guide
This User Guide (UG) complements the Dataset-JSON API Specification published as HTML and JSON in the
[Dataset-JSON API GitHub repository](https://github.com/cdisc-org/DataExchange-DatasetJson-API). This UG provides 
additional information to aid those implementing Dataset-JSON APIs.

The main purpose of DataExchange-DatasetJson-API is to create a standard API specification for Dataset-JSON. Conformant 
Dataset-JSON servers may support the entire standard specification or a read-only instance.

The standard REST API specification for Dataset-JSON is based on the version 1.1 specification found in [Dataset-JSON
GitHub repository](https://github.com/cdisc-org/DataExchange-DatasetJson).

## Open API Specification
The primary technical documentation for the Dataset-JSON API is found in the 
[Open API Specification 3.1 (OAS) for the Dataset-JSON API](https://github.com/cdisc-org/DataExchange-DatasetJson-API/blob/main/openapi/dataset-json-api.json).
An [HTML version of the specification](https://github.com/cdisc-org/DataExchange-DatasetJson-API/blob/main/doc/dataset-json-api-1-0.html) 
has been generated as a human-readable representation. The machine-readable JSON version of the OAS Dataset-JSON API 
specification includes a machine-readable representation of the endpoints and JSON payload that may be used by code
generators to create basic client and server software.

## API Implementations
The specification focuses on data exchange to keep the API implementation simple. Implementers may seek to extend the API
to add additional features, such as filtering datasets for specific rows that meet a given criteria, but these
advanced features are not part of the standard. Ease of implementation was a key design principle for the API specification.

For those implementing the API, there are 2 paths to conformance with the standard
1. Implement a read-only API by implementing the GET verbs. 
2. Implement a CRUD (Create Read Update Delete) API that allows clients to create, read, update, delete, and append to datasets.

A read-only API implementation implements all the GET verbs, and not the other verbs. For example, an 
EDC system implementing the API may allow clients to retrieve datasets, but not to create or update datasets.

Systems must implement all required elements of the specification to be conformant. For a read-only implementation, this means
implementing each GET request completely to include all required parameters and features. CRUD implementations must
implement all verbs with all required parameters and features in the specification.

## REST API
The Dataset-JSON API is a REST-based API specification. REST, or 
[Representational State Transfer](https://ics.uci.edu/~fielding/pubs/dissertation/top.htm), is architectural style for 
distributed hypermedia systems first presented in Roy Fielding's 2000 dissertation. REST is the most widely implemented 
architecture for building web-based APIs.  

## HTTP Verbs
* GET is used to retrieve content such as a list of studies, a study, a list of datasets, or a dataset
* POST is used to create a new study or dataset
* PUT is used to update an entire study or dataset
* PATCH is used to append a data rows to a dataset
* DELETE is used to soft delete a study or dataset

## JSON and NDJSON
The Dataset-JSON API returns and accepts the JSON representation of Dataset-JSON. Although NDJSON is part of the
Dataset-JSON specification, the API does not exchange NDJSON. NDJSON works well for representing Dataset-JSON files, 
especially for large datasets.

## Usage
In this User Guide, example endpoints will use a local IP address: 
```
http://127.0.0.1:8000/
```

To load the API documentation generated by the OAS specification:
```
http://127.0.0.1:8000/docs#/
```

Note: For Dataset-JSON API implementations, you will need to replace the host name and port to use your own URL. 
For example, http://127.0.0.1:8000/ becomes:
```
https://dsjapi.net/
```

## Usage Examples
Replace the host and port to match the API implementation. The api_key used in the examples must be replaced with a 
valid key.

### Read-only API Examples
| Description                                                                        | Description                                                                                                          |
|--------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------|
| GET the about resource                                                   | curl http://127.0.0.1:8000/about                                                                                     |
| GET the home resource (html page)                                        | curl http://127.0.0.1:8000/                                                                                          |
| GET the current list of studies                                          | curl http://127.0.0.1:8000/studies                                                                                   |
| GET a specific study                                                     | curl http://127.0.0.1:8000/studies/CDISCPILOT01                                                                      |
| GET the list of datasets for a specified study                           | curl http://127.0.0.1:8000/studies/CDISCPILOT02/datasets                                                             |
| GET the list of datasets for a specified study and filter by datetime    | curl http://127.0.0.1:8000/studies/CDISCPILOT02/datasets -H "IF-Modified-Since: 2024-01-10T20:38:47"                 |
| GET the list of datasets with a standard filter of sdtmig                | curl http://127.0.0.1:8000/studies/CDISCPILOT02/datasets?standard=sdtmig                                             |
| GET the list of datasets for a study and filter by datetime and standard | curl http://127.0.0.1:8000/studies/CDISCPILOT02/datasets?standard=sdtmig -H "IF-Modified-Since: 2024-01-10T20:38:47" |
| GET the IG.AE dataset                                                    | curl http://127.0.0.1:8000/studies/CDISCPILOT01/datasets/IG.AE                                                       |
| GET the IG.AE dataset with IF-Modified-Since same as creationDateTime    | curl http://127.0.0.1:8000/studies/CDISCPILOT01/datasets/IG.AE -i -H "IF-Modified-Since: 2024-01-10T20:38:47"        |
| GET gzipped content                                                      | curl http://127.0.0.1:8000/studies/CDISCPILOT02/datasets/IG.DD?standard=sdtmig -H "Accept-Encoding: gzip, deflate"   |
| GET dataset metadata only                                                | curl http://127.0.0.1:8000/studies/CDISCPILOT01/datasets/IG.AE?metadataonly=True                                     |
| GET page of data using offset and limit                                  | curl "http://127.0.0.1:8000/studies/CDISCPILOT01/datasets/IG.AE?offset=10&limit=40"                                  |

### Write, Update, Append, Delete API Examples
| Description                                                  | Description                                                                                                                                                                                                                                                    |
|--------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| POST a new study                                             | curl http://127.0.0.1:8000/studies -H "Content-Type: application/json" -H "api-key: x1y62c5b-e29d-8fa5-af31-63c2be65681a" -d  "{\"oid\": \"CDISCPILOT03\", \"name\": \"CDISCPILOT03\", \"label\": \"Study Data Tabulation Model Metadata Submission Guidelines Sample Study\", \"standards\": [\"sdtmig\"], \"href\": \"/studies/CDISCPILOT03\"}" |
| PUT update the newly added study                             | curl http://127.0.0.1:8000/studies/CDISCPILOT03 -X PUT -H "Content-Type: application/json" -H "api-key: x1y62c5b-e29d-8fa5-af31-63c2be65681a" -d  "{\"oid\": \"CDISCPILOT03\", \"name\": \"CDISCPILOT03\", \"label\": \"SDTM MSG Sample Study\", \"standards\": [\"sdtmig\"], \"href\": \"/studies/CDISCPILOT03\"}" |
| POST add a new dataset to the new study                      | curl http://127.0.0.1:8000/studies/CDISCPILOT03/datasets -H "Content-Type: application/json" -H "api-key: x1y62c5b-e29d-8fa5-af31-63c2be65681a" -d  @.\test-data\ig-dd.json                                                     |
| PUT update the newly added dataset                           | curl http://127.0.0.1:8000/studies/CDISCPILOT03/datasets/IG.DD -X PUT -H "Content-Type: application/json" -H "api-key: x1y62c5b-e29d-8fa5-af31-63c2be65681a" -d  @.\test-data\ig-dd-put.json                                                                   |
| PATCH append a record to the newly added dataset             | curl http://127.0.0.1:8000/studies/CDISCPILOT03/datasets/IG.DD -X PATCH -H "Content-Type: application/json" -H "api-key: x1y62c5b-e29d-8fa5-af31-63c2be65681a" -d @.\test-data\ig-dd-patch.json                                                                |
| POST add new dataset to the new study using Gzip compression | curl http://127.0.0.1:8000/studies/CDISCPILOT03/datasets -H "Content-Encoding: application/gzip" -H "Content-Type: application/json" -H "api-key: x1y62c5b-e29d-8fa5-af31-63c2be65681a" --data-binary @.\test-data\ig-ta.gz                                    |
| DELETE the IG.TA dataset                                     | curl http://127.0.0.1:8000/studies/CDISCPILOT03/datasets/IG.TA -X DELETE -I -H "api-key: x1y62c5b-e29d-8fa5-af31-63c2be65681a"                                                                                                                                 |

## Optional Endpoints and Features
At a minimum, each Dataset-JSON API instance should implement a read-only API. This means implementing the GET verb for
all required endpoints. A full CRUD API is optional.

A few API features are optional, and a server does not need to support them to be conformant.
- Multiple environments
- Dataset versioning
- Define-XML retrieval

If a server does not implement an optional endpoint, it should return a 501 status code to indicate to the client that
the feature is not available.

### Adding Support for Multiple Environments

When using the API with multiple environments, such as QA and Production, use a different base URL for each environment.
Building on our previous example where the base URL is http://127.0.0.1:8000/, create different base URLs to support
different environments, for example:
* http://127.0.0.1:8000/qa
* http://127.0.0.1:8000/uat
* http://127.0.0.1:8000/prod

Each environment serves datasets that are undergoing QA, UAT, or Production. Not all implementers will opt to use
multiple environments, so this strategy only applies to those interested in having the API serve datasets from different
environments.

### Working with Dataset Versions

By default, a Dataset-JSON API returns the latest version of each available dataset. 
Optionally, API implementers may add a version query parameter to request a specific version of a dataset. The version
API feature is optional. It is not required to be conformant with the Dataset-JSON API standard.

The _version_ query parameter may be added to the following endpoints:
- /studies/{StudyOID}/datasets
- /studies/{StudyOID}/datasets/{ItemGroupOID}

The value of the _version_ query parameter is either "all" or a specific version such as "1". For example:
```
http://127.0.0.1:8000/studies/CDISCPILOT01/datasets?version="all"
http://127.0.0.1:8000/studies/CDISCPILOT01/datasets/IG.AE?version="all"
http://127.0.0.1:8000/studies/CDISCPILOT01/datasets?version="1"
http://127.0.0.1:8000/studies/CDISCPILOT01/datasets/IG.AE?version="1"
```

The value of dataset version text is not constrained to a specific format, and any text string implemented by the server
to indicate the dataset version may be used.

### Retrieving the Define-XML Content
The Study response object includes the _metaDataRef_ attribute that provides a URI to the Define-XML metadata. For
example, the URI could be a URL to download a define.xml file or an endpoint to get the metadata via a REST API.
Implementing the metaDataRef attribute is optional. It is not required to conform with the Dataset-JSON API standard. 
Not all data providers that implement a Dataset-JSON API will produce the Define-XML metadata. The Dataset-JSON
API specification does not specify how a metaDataRef URI functions to retrieve the Define-XML metadata.

## API Identifiers
The Dataset-JSON API uses the StudyOID and ItemGroupOID as identifiers in the API. For example, to request a specific
dataset the URL must contain the StudyOID and the ItemGroupOID to indicate the dataset of interest. Here's an example 
URL requesting the AE dataset for the CDISCPILOT01 study.
```
http://127.0.0.1:8000/studies/CDISCPILOT01/datasets/IG.AE
```

In the above example, the StudyOID is CDISCPILOT01 and the ItemGroupOID is IG.AE. Since these OIDs, also used in an 
associated Define-XML file, are used in the URL, avoid using certain characters in the OIDs to better support usage in 
a URL, such as:
- '#' (fragment identifier)
- '?' (query string delimiter)
- '&' (query string parameter separator)
- '=' (assigns values to query string parameters)
- '+' (represents a space in query strings)
- '%' (used for URL encoding)
- '/' (path separator)

## HATEOAS
HATEOAS, or Hypertext As The Engine of Application State, means that a REST API must provide hypermedia links in its 
responses, guiding clients through available actions and resources. The Dataset-JSON API does provide hyperlinks to inform
clients of the available study and dataset resources. The API specification does not include a _links section to represent
the hyperlinks, but the relevant URLs are available in the body of the response. Many REST APIs, such as the
CDISC Library, include a _links section, but it was not included in the Dataset-JSON API specification to simplify the 
API implementation. To support HATEOAS, the URLs are available in the body of the responses.

## Metadata and Data Only Flags
Clients may request to receive only the dataset metadata or only the dataset data. By default, responses include the 
metadata and data parts of the Dataset-JSON dataset. Depending on the usage scenario, it may be preferable to only 
receive the metadata or the data, and metadataonly=True or dataonly=True query parameters make that possible. The entire 
dataset is returned by default.

## HTTP Status Codes
| Status Code | Definition            | Description                                                                                                 |
|-------------|-----------------------|-------------------------------------------------------------------------------------------------------------|
| 200         | OK                    | The request was successfully processed                                                                      |
| 201         | Successfully created  | Indicates that the request was successful and a new resource has been created as a result                   |
| 204         | No content            | The server successfully processed a request but no content is returned in the response body                 |
| 304         | Not modified          | The client's cached version of a resource is still valid and should be used instead of re-downloading it    | 
| 400         | Bad request           | The server couldn't process the request due to a client-side issue, usually an invalid or malformed request | 
| 401         | Unauthorized          | The server requires authentication to grant access to the requested resource                                | 
| 404         | Not Found             | The server could not locate the requested resource                                                          |
| 409         | Conflict              | The server cannot complete the request due to a conflict with the current state of the resource             |
| 413         | Content too large     | Unable to process the request due to the content being too large to process                                 |
| 422         | Unprocessable entity  | The server cannot complete the request due to a conflict with the current state of the resource             | 
| 500         | Internal server error | The server encountered an unexpected condition and couldn't complete the request |
| 501         | Not implemented       | For optional features that are not supported by an implementation |

## Implementation Notes
- If no datasets that match user specified criteria are found, a status code of 200 with content {'datasets': []} is returned
- If a specific dataset is requested and not found, a 404 status code is returned
- The standard filter is not case-sensitive so that standard=sdtmig and standard=SDTMIG are both valid query parameters.
- The standard filters include: "sdtmig", "sendig", "adamig", and "other".
- Gzip compression should be supported by API implementation. Alternative standard compression algorithms may also be used, such as Brotli or Zstandard.
- After a dataset has been posted (created) the API returns the Study Dataset metadata, but not the full dataset that was posted
- Full list of available HTTP status codes: https://www.iana.org/assignments/http-status-codes/http-status-codes.xhtml
- When posting a study or dataset that already exists, a 409 status code will be returned 
- When requesting a dataset too large for the server to process, a 413 status code will be returned and the client may opt to re-send the request for a chunk of records instead of the entire dataset
- When posting a dataset to a study that does not exist, a 422 status code will be returned
- The Dataset-JSON API works with JSON, and does not support the exchange of NDJSON.

## Assumptions
- The API standard focuses on data exchange over other use cases such as querying or creating slices, which may be added to an extended version of the API
- A read-only API implementation is valid 
- In practice, the API will not be supporting so many active studies at one time that a filter is needed on the studies returned
- Most dataset retrievals will use gzip compression
- Many APIs will never read or write to a Dataset-JSON file, but instead will read and write to a data store and only use Dataset-JSON to send and receive data from API clients.
- The current API specification supports Dataset-JSON v1.1
